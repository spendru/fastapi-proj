FROM public.ecr.aws/lambda/python:3.9

# Install system dependencies
RUN yum install -y \
    gcc \
    unixODBC \
    unixODBC-devel \
    tar \
    gzip \
    make \
    which \
    openssl \
    libffi-devel \
    && yum clean all

# Install Microsoft ODBC Driver for SQL Server
RUN curl -o /etc/yum.repos.d/mssql-release.repo https://packages.microsoft.com/config/rhel/7/prod.repo \
    && ACCEPT_EULA=Y yum install -y \
    msodbcsql17 \
    mssql-tools \
    && yum clean all

# Add Microsoft ODBC Driver to PATH
ENV PATH="/opt/mssql-tools/bin:${PATH}"

# Install Python dependencies
RUN pip install --no-cache-dir \
    pyodbc \
    pandas \
    sqlalchemy \
    pymssql

# Set the command to run the Lambda function handler
CMD ["app.lambda_handler"]
