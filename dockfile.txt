FROM public.ecr.aws/lambda/python:3.9

# Install system dependencies
RUN yum install -y \
    gcc \
    unixODBC \
    unixODBC-devel \
    tar \
    gzip \
    make \
    which \
    libffi-devel \
    curl \
    && yum clean all

# Install OpenSSL 1.1 (instead of default OpenSSL 1.0.2)
RUN yum remove -y openssl openssl-libs \
    && yum install -y openssl11 \
    && ln -s /usr/bin/openssl11 /usr/bin/openssl

# Install Microsoft ODBC Driver for SQL Server
RUN curl -o /etc/yum.repos.d/mssql-release.repo https://packages.microsoft.com/config/rhel/7/prod.repo \
    && ACCEPT_EULA=Y yum install -y \
    msodbcsql17 \
    mssql-tools \
    && yum clean all

# Verify OpenSSL version (Ensure OpenSSL 1.1 is being used)
RUN openssl version

# Add Microsoft ODBC Driver to PATH
ENV PATH="/opt/mssql-tools/bin:${PATH}"

# Install Python dependencies
RUN pip install --no-cache-dir \
    pyodbc \
    pandas \
    sqlalchemy \
    pymssql

# Set the command to run the Lambda function handler
CMD ["app.lambda_handler"]
